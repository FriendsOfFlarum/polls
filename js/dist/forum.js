(()=>{var t={n:o=>{var n=o&&o.__esModule?()=>o.default:()=>o;return t.d(n,{a:n}),n},d:(o,n)=>{for(var e in n)t.o(n,e)&&!t.o(o,e)&&Object.defineProperty(o,e,{enumerable:!0,get:n[e]})},o:(t,o)=>Object.prototype.hasOwnProperty.call(t,o),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},o={};(()=>{"use strict";t.r(o),t.d(o,{components:()=>it,extend:()=>wt,models:()=>dt});const n=flarum.core.compat["forum/app"];var e=t.n(n);const a=flarum.core.compat["common/extend"],l=flarum.core.compat["common/components/Badge"];var s=t.n(l);const i=flarum.core.compat["forum/components/DiscussionList"];var r=t.n(i);const p=flarum.core.compat["common/models/Discussion"];var u=t.n(p);const c=flarum.core.compat["common/utils/classList"];var d=t.n(c);const h=flarum.core.compat["forum/components/DiscussionComposer"];var f=t.n(h);const v=flarum.core.compat["forum/components/ReplyComposer"];var b=t.n(v);function g(t,o){return g=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,o){return t.__proto__=o,t},g(t,o)}function y(t,o){t.prototype=Object.create(o.prototype),t.prototype.constructor=t,g(t,o)}const w=flarum.core.compat["common/components/Button"];var V=t.n(w);const P=flarum.core.compat["common/components/Modal"];var x=t.n(P);const N=flarum.core.compat["common/components/Switch"];var M=t.n(N);const O=flarum.core.compat["common/utils/ItemList"];var C=t.n(O);const _=flarum.core.compat["common/utils/Stream"];var D=t.n(_);const I=flarum.core.compat["common/utils/extractText"];var S=t.n(I),k=function(t){function o(){return t.apply(this,arguments)||this}y(o,t);var n=o.prototype;return n.oninit=function(o){var n=this;t.prototype.oninit.call(this,o),this.options=[D()(""),D()("")],this.optionImageUrls=[D()(""),D()("")],this.question=D()(""),this.endDate=D()(),this.publicPoll=D()(!1),this.hideVotes=D()(!1),this.allowChangeVote=D()(!0),this.allowMultipleVotes=D()(!1),this.maxVotes=D()(0),this.datepickerMinDate=this.formatDate(void 0);var e=this.attrs.poll;e&&Array.isArray(e.options)&&(this.options=[],this.optionImageUrls=[],e.options.forEach((function(t){n.options.push(D()(t.answer)),n.optionImageUrls.push(D()(t.imageUrl))})),this.question(e.question),this.publicPoll(e.publicPoll),this.hideVotes(e.hideVotes),this.allowChangeVote(e.allowChangeVote),this.allowMultipleVotes(e.allowMultipleVotes),this.maxVotes(e.maxVotes||0),this.endDate(this.formatDate(e.endDate)),this.endDate()&&dayjs(e.endDate).isAfter(dayjs())&&(this.datepickerMinDate=this.formatDate(e.endDate)))},n.title=function(){return e().translator.trans("fof-polls.forum.modal.add_title")},n.className=function(){return"PollDiscussionModal Modal--medium"},n.content=function(){return[m("div",{className:"Modal-body"},m("div",{className:"PollDiscussionModal-form"},this.fields().toArray()))]},n.fields=function(){var t=new(C());return t.add("question",m("div",{className:"Form-group"},m("label",{className:"label"},e().translator.trans("fof-polls.forum.modal.question_placeholder")),m("input",{type:"text",name:"question",className:"FormControl",bidi:this.question})),100),t.add("answers",m("div",{className:"PollModal--answers Form-group"},m("label",{className:"label PollModal--answers-title"},m("span",null,e().translator.trans("fof-polls.forum.modal.options_label")),V().component({className:"Button PollModal--button small",icon:"fas fa-plus",onclick:this.addOption.bind(this)})),this.displayOptions()),80),t.add("date",m("div",{className:"Form-group"},m("label",{className:"label"},e().translator.trans("fof-polls.forum.modal.date_placeholder")),m("div",{className:"PollModal--date"},m("input",{className:"FormControl",type:"datetime-local",name:"date",bidi:this.endDate,min:this.datepickerMinDate,max:this.formatDate("2038")}),V().component({className:"Button PollModal--button",icon:"fas fa-times",onclick:this.endDate.bind(this,null)})),this.endDate()&&m("p",{className:"helpText"},m("i",{class:"icon fas fa-clock"}),"Â ",dayjs(this.endDate()).isBefore(dayjs())?e().translator.trans("fof-polls.forum.poll_ended"):e().translator.trans("fof-polls.forum.days_remaining",{time:dayjs(this.endDate()).fromNow()}))),40),t.add("public",m("div",{className:"Form-group"},M().component({state:this.publicPoll()||!1,onchange:this.publicPoll},e().translator.trans("fof-polls.forum.modal.public_poll_label"))),20),t.add("hide-votes",m("div",{className:"Form-group"},m(M(),{state:this.endDate()&&this.hideVotes(),onchange:this.hideVotes,disabled:!this.endDate()},e().translator.trans("fof-polls.forum.modal.hide_votes_label"))),20),t.add("allow-change-vote",m("div",{className:"Form-group"},m(M(),{state:this.allowChangeVote(),onchange:this.allowChangeVote},e().translator.trans("fof-polls.forum.modal.allow_change_vote_label"))),20),t.add("allow-multiple-votes",m("div",{className:"Form-group"},M().component({state:this.allowMultipleVotes()||!1,onchange:this.allowMultipleVotes},e().translator.trans("fof-polls.forum.modal.allow_multiple_votes_label"))),15),this.allowMultipleVotes()&&t.add("max-votes",m("div",{className:"Form-group"},m("label",{className:"label"},e().translator.trans("fof-polls.forum.modal.max_votes_label")),m("input",{type:"number",min:"0",max:this.options.length,name:"maxVotes",className:"FormControl",bidi:this.maxVotes}),m("p",{className:"helpText"},e().translator.trans("fof-polls.forum.modal.max_votes_help"))),15),t.add("submit",m("div",{className:"Form-group"},V().component({type:"submit",className:"Button Button--primary PollModal-SubmitButton",loading:this.loading},e().translator.trans("fof-polls.forum.modal.submit"))),-10),t},n.displayOptions=function(){var t=this;return Object.keys(this.options).map((function(o,n){return m("div",{className:"Form-group"},m("fieldset",{className:"Poll-answer-input"},m("input",{className:"FormControl",type:"text",name:"answer"+(n+1),bidi:t.options[n],placeholder:e().translator.trans("fof-polls.forum.modal.option_placeholder")+" #"+(n+1)}),e().forum.attribute("allowPollOptionImage")?m("input",{className:"FormControl",type:"text",name:"answerImage"+(n+1),bidi:t.optionImageUrls[n],placeholder:e().translator.trans("fof-polls.forum.modal.image_option_placeholder")+" #"+(n+1)}):null),n>=2?V().component({type:"button",className:"Button Button--warning PollModal--button",icon:"fas fa-minus",onclick:n>=2?t.removeOption.bind(t,n):""}):"")}))},n.addOption=function(){var t=Math.max(e().forum.attribute("pollMaxOptions"),2);this.options.length<t?(this.options.push(D()("")),this.optionImageUrls.push(D()(""))):alert(S()(e().translator.trans("fof-polls.forum.modal.max",{max:t})))},n.removeOption=function(t){this.options.splice(t,1),this.optionImageUrls.splice(t,1)},n.data=function(){var t=this,o={question:this.question(),endDate:this.dateToTimestamp(this.endDate()),publicPoll:this.publicPoll(),hideVotes:this.hideVotes(),allowChangeVote:this.allowChangeVote(),allowMultipleVotes:this.allowMultipleVotes(),maxVotes:this.maxVotes(),options:[]};return this.options.forEach((function(n,e){n()&&o.options.push({answer:n(),imageUrl:t.optionImageUrls[e]()})})),""===this.question()?(alert(e().translator.trans("fof-polls.forum.modal.include_question")),null):o.options.length<2?(alert(e().translator.trans("fof-polls.forum.modal.min")),null):o},n.onsubmit=function(t){var o=this;t.preventDefault();var n=this.data();if(null!==n){var a=this.attrs.onsubmit(n);a instanceof Promise?(this.loading=!0,a.then(this.hide.bind(this),(function(t){console.error(t),o.onerror(t),o.loaded()}))):e().modal.close()}},n.formatDate=function(t,o){void 0===o&&(o=!1);var n=dayjs(t);return!1!==t&&n.isValid()?n.format("YYYY-MM-DDTHH:mm"):!1!==o?this.formatDate(o):null},n.dateToTimestamp=function(t){var o=dayjs(t);return!(!t||!o.isValid())&&o.format()},o}(x()),A=function(t){t.prototype.addPoll=function(){var t=this;e().modal.show(k,{poll:this.composer.fields.poll,onsubmit:function(o){return t.composer.fields.poll=o}})},(0,a.extend)(t.prototype,"headerItems",(function(t){var o,n,a,l=null==(o=this.composer.body)||null==(n=o.attrs)?void 0:n.discussion;(null!=(a=null==l?void 0:l.canStartPoll())?a:e().forum.canStartPolls())&&t.add("polls",m("a",{className:"ComposerBody-poll",onclick:this.addPoll.bind(this)},m("span",{className:d()("PollLabel",!this.composer.fields.poll&&"none")},e().translator.trans("fof-polls.forum.composer_discussion."+(this.composer.fields.poll?"edit":"add")+"_poll"))),1)})),(0,a.extend)(t.prototype,"data",(function(t){this.composer.fields.poll&&(t.poll=this.composer.fields.poll)}))};const U=flarum.core.compat["forum/components/CommentPost"];var j=t.n(U);const q=flarum.core.compat["common/Component"];var B=t.n(q);const E=flarum.core.compat["forum/components/LogInModal"];var F=t.n(E);const T=flarum.core.compat["common/helpers/avatar"];var H=t.n(T);const L=flarum.core.compat["common/helpers/username"];var R=t.n(L);const Y=flarum.core.compat["common/components/Link"];var z=t.n(Y);const J=flarum.core.compat["common/components/LoadingIndicator"];var $=t.n(J),G=function(t){function o(){return t.apply(this,arguments)||this}y(o,t);var n=o.prototype;return n.oninit=function(o){var n=this;t.prototype.oninit.call(this,o),this.loading=D()(!0),e().store.find("fof/polls",this.attrs.poll.id(),{include:"votes,votes.user,votes.option"}).then((function(){return n.loading(!1)})).finally((function(){return m.redraw()}))},n.className=function(){return"Modal--medium VotesModal"},n.title=function(){return e().translator.trans("fof-polls.forum.votes_modal.title")},n.content=function(){return m("div",{className:"Modal-body"},this.loading()?m($(),null):this.attrs.poll.options().map(this.optionContent.bind(this)))},n.optionContent=function(t){var o=(this.attrs.poll.votes()||[]).filter((function(o){return t.id()===o.option().id()}));return m("div",{className:"VotesModal-option"},m("h2",null,t.answer()+":"),o.length?m("div",{className:"VotesModal-list"},o.map(this.voteContent.bind(this))):m("h4",null,e().translator.trans("fof-polls.forum.modal.no_voters")))},n.voteContent=function(t){var o=t.user(),n=o&&{href:e().route.user(o)};return m(z(),n,H()(o)," ",R()(o))},o}(x());const K=flarum.core.compat["common/components/Tooltip"];var Q=t.n(K);const W=flarum.core.compat["common/helpers/icon"];var X=t.n(W),Z=function(t){function o(){return t.apply(this,arguments)||this}y(o,t);var n=o.prototype;return n.oninit=function(o){t.prototype.oninit.call(this,o),this.poll=this.attrs.poll,this.options=this.poll.options(),this.optionAnswers=this.options.map((function(t){return D()(t.answer())})),this.optionImageUrls=this.options.map((function(t){return D()(t.imageUrl())})),this.question=D()(this.poll.question()),this.endDate=D()(this.formatDate(this.poll.endDate())),this.publicPoll=D()(this.poll.publicPoll()),this.allowMultipleVotes=D()(this.poll.allowMultipleVotes()),this.hideVotes=D()(this.poll.hideVotes()),this.allowChangeVote=D()(this.poll.allowChangeVote()),this.maxVotes=D()(this.poll.maxVotes()||0),this.endDate()&&dayjs(this.poll.endDate()).isAfter(dayjs())&&(this.datepickerMinDate=this.formatDate(this.endDate()))},n.title=function(){return e().translator.trans("fof-polls.forum.modal.edit_title")},n.displayOptions=function(){var t=this;return this.options.map((function(o,n){return m("div",{className:"Form-group"},m("fieldset",{className:"Poll-answer-input"},m("input",{className:"FormControl",type:"text",name:"answer"+(n+1),bidi:t.optionAnswers[n],placeholder:e().translator.trans("fof-polls.forum.modal.option_placeholder")+" #"+(n+1)}),e().forum.attribute("allowPollOptionImage")?m("input",{className:"FormControl",type:"text",name:"answerImage"+(n+1),bidi:t.optionImageUrls[n],placeholder:e().translator.trans("fof-polls.forum.modal.image_option_placeholder")+" #"+(n+1)}):null),n>=2?V().component({type:"button",className:"Button PollModal--button",icon:"fas fa-minus",onclick:n>=2?t.removeOption.bind(t,n):""}):"")}))},n.addOption=function(){var t=Math.max(e().forum.attribute("pollMaxOptions"),2);this.options.length<t?(this.options.push(e().store.createRecord("poll_options")),this.optionAnswers.push(D()("")),this.optionImageUrls.push(D()(""))):alert(S()(e().translator.trans("fof-polls.forum.modal.max",{max:t})))},n.removeOption=function(t){this.options.splice(t,1),this.optionAnswers.splice(t,1),this.optionImageUrls.splice(t,1)},n.data=function(){var t=this,o=this.options.map((function(o,n){return o.data.attributes||(o.data.attributes={}),o.data.attributes.answer=t.optionAnswers[n](),o.data.attributes.imageUrl=t.optionImageUrls[n](),o.data}));return{question:this.question(),endDate:this.dateToTimestamp(this.endDate()),publicPoll:this.publicPoll(),hideVotes:this.hideVotes(),allowChangeVote:this.allowChangeVote(),allowMultipleVotes:this.allowMultipleVotes(),maxVotes:this.maxVotes(),options:o}},n.onsubmit=function(t){var o=this;if(t.preventDefault(),!this.loading)return this.loading=!0,this.poll.save(this.data()).then((function(){o.hide(),m.redraw()})).catch((function(t){o.loaded(),o.onerror(t)}))},o}(k),tt=function(t){function o(){return t.apply(this,arguments)||this}y(o,t);var n=o.prototype;return n.oninit=function(o){var n,e;t.prototype.oninit.call(this,o),this.loadingOptions=!1,this.useSubmitUI=!(null!=(n=this.attrs.poll)&&n.canChangeVote())&&(null==(e=this.attrs.poll)?void 0:e.allowMultipleVotes()),this.pendingSubmit=!1,this.pendingOptions=null},n.oncreate=function(o){t.prototype.oncreate.call(this,o),this.preventClose=this.preventClose.bind(this),window.addEventListener("beforeunload",this.preventClose)},n.onremove=function(o){t.prototype.onremove.call(this,o),window.removeEventListener("beforeunload",this.preventClose)},n.view=function(){var t=this.attrs.poll,o=t.options()||[],n=t.allowMultipleVotes()?t.maxVotes():1;0===n&&(n=o.length);var a=this.infoItems(n);return m("div",{className:"Post-poll","data-id":t.id()},m("div",{className:"PollHeading"},m("h3",{className:"PollHeading-title"},t.question()),t.canSeeVoters()&&m(Q(),{text:e().translator.trans("fof-polls.forum.public_poll")},m(V(),{className:"Button PollHeading-voters",onclick:this.showVoters.bind(this),icon:"fas fa-poll"})),t.canEdit()&&m(Q(),{text:e().translator.trans("fof-polls.forum.moderation.edit")},m(V(),{className:"Button PollHeading-edit",onclick:e().modal.show.bind(e().modal,Z,{poll:t}),icon:"fas fa-pen"})),t.canDelete()&&m(Q(),{text:e().translator.trans("fof-polls.forum.moderation.delete")},m(V(),{className:"Button PollHeading-delete",onclick:this.deletePoll.bind(this),icon:"fas fa-trash"}))),m("div",null,m("div",{className:"PollOptions"},o.map(this.viewOption.bind(this))),m("div",{className:"Poll-sticky"},!a.isEmpty()&&m("div",{className:"helpText PollInfoText"},a.toArray()),this.useSubmitUI&&this.pendingSubmit&&m(V(),{className:"Button Button--primary Poll-submit",loading:this.loadingOptions,onclick:this.onsubmit.bind(this)},e().translator.trans("fof-polls.forum.poll.submit_button")))))},n.infoItems=function(t){var o,n=new(C()),a=this.attrs.poll,l=(null==(o=a.myVotes())?void 0:o.length)>0;return!e().session.user||a.canVote()||a.hasEnded()||n.add("no-permission",m("span",null,m("i",{className:"icon fas fa-times-circle fa-fw"}),e().translator.trans("fof-polls.forum.no_permission"))),a.endDate()&&n.add("end-date",m("span",null,m("i",{class:"icon fas fa-clock fa-fw"}),a.hasEnded()?e().translator.trans("fof-polls.forum.poll_ended"):e().translator.trans("fof-polls.forum.days_remaining",{time:dayjs(a.endDate()).fromNow()}))),a.canVote()&&(n.add("max-votes",m("span",null,m("i",{className:"icon fas fa-poll fa-fw"}),e().translator.trans("fof-polls.forum.max_votes_allowed",{max:t}))),a.canChangeVote()||n.add("cannot-change-vote",m("span",null,m("i",{className:"icon fas fa-"+(l?"times":"exclamation")+"-circle fa-fw"}),e().translator.trans("fof-polls.forum.poll.cannot_change_vote")))),n},n.viewOption=function(t){var o,n,a,l=this.attrs.poll,s=(null==(o=l.myVotes())?void 0:o.length)>0,i=l.voteCount(),r=this.pendingOptions?this.pendingOptions.has(t.id()):null==(n=l.myVotes())||null==n.some?void 0:n.some((function(o){return o.option()===t})),p=t.voteCount(),u=i>0?Math.round(p/i*100):0,c="number"==typeof p,h=this.loadingOptions||s&&!l.canChangeVote(),f=c?u:Number(r)/((null==(a=l.myVotes())?void 0:a.length)||1)*100,v=!e().session.user||!l.hasEnded()&&l.canVote()&&(!s||l.canChangeVote()),b=m("div",{className:"PollBar","data-selected":!!r,style:"--poll-option-width: "+f+"%"},v&&m("label",{className:"PollAnswer-checkbox checkbox"},m("input",{onchange:this.changeVote.bind(this,t),type:"checkbox",checked:r,disabled:h}),m("span",{className:"checkmark"})),m("div",{className:"PollAnswer-text"},m("span",{className:"PollAnswer-text-answer"},t.answer()),r&&!v&&X()("fas fa-check-circle",{className:"PollAnswer-check"}),c&&m("span",{className:d()("PollPercent",100!==u&&"PollPercent--option")},u,"%")),t.imageUrl()?m("img",{className:"PollAnswer-image",src:t.imageUrl(),alt:t.answer()}):null);return m("div",{className:d()("PollOption",s&&"PollVoted",l.hasEnded()&&"PollEnded",t.imageUrl()&&"PollOption-hasImage"),"data-id":t.id()},c?m(Q(),{text:e().translator.trans("fof-polls.forum.tooltip.votes",{count:p}),onremove:this.hideOptionTooltip},b):b)},n.changeVote=function(t,o){var n,a;if(!e().session.user)return e().modal.show(F()),void(o.target.checked=!1);var l=this.pendingOptions||new Set(null==(n=(a=this.attrs.poll.myVotes()).map)?void 0:n.call(a,(function(t){return t.option().id()}))),s=l.delete(t.id());return this.attrs.poll.allowMultipleVotes()||l.clear(),s||l.add(t.id()),this.useSubmitUI?(this.pendingOptions=l.size?l:null,void(this.pendingSubmit=!!this.pendingOptions)):this.submit(l,null,(function(){return o.target.checked=s}))},n.onsubmit=function(){var t=this;return this.submit(this.pendingOptions,(function(){t.pendingOptions=null,t.pendingSubmit=!1}))},n.submit=function(t,o,n){var a=this;return this.loadingOptions=!0,m.redraw(),e().request({method:"PATCH",url:e().forum.attribute("apiUrl")+"/fof/polls/"+this.attrs.poll.id()+"/votes",body:{data:{optionIds:Array.from(t)}}}).then((function(t){e().store.pushPayload(t),null==o||o()})).catch((function(t){null==n||n(t)})).finally((function(){a.loadingOptions=!1,m.redraw()}))},n.showVoters=function(){e().modal.show(G,{poll:this.attrs.poll,post:this.attrs.post})},n.deletePoll=function(){confirm(e().translator.trans("fof-polls.forum.moderation.delete_confirm"))&&this.attrs.poll.delete().then((function(){m.redraw.sync()}))},n.hideOptionTooltip=function(t){t.attrs.tooltipVisible=!1,t.state.updateVisibility()},n.preventClose=function(t){if(this.pendingOptions)return t.preventDefault(),!0},o}(B());const ot=flarum.core.compat["forum/components/DiscussionPage"];var nt=t.n(ot);function et(t,o){(null==o||o>t.length)&&(o=t.length);for(var n=0,e=new Array(o);n<o;n++)e[n]=t[n];return e}function at(){return at=Object.assign?Object.assign.bind():function(t){for(var o=1;o<arguments.length;o++){var n=arguments[o];for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])}return t},at.apply(this,arguments)}const lt=flarum.core.compat["forum/utils/PostControls"];var st=t.n(lt),it={CreatePollModal:k,PostPoll:tt,EditPollModal:Z,ListVotersModal:G};const rt=flarum.core.compat["common/Model"];var mt=t.n(rt),pt=function(t){function o(){for(var o,n=arguments.length,e=new Array(n),a=0;a<n;a++)e[a]=arguments[a];return(o=t.call.apply(t,[this].concat(e))||this).question=mt().attribute("question"),o.hasEnded=mt().attribute("hasEnded"),o.endDate=mt().attribute("endDate"),o.publicPoll=mt().attribute("publicPoll"),o.hideVotes=mt().attribute("hideVotes"),o.allowChangeVote=mt().attribute("allowChangeVote"),o.allowMultipleVotes=mt().attribute("allowMultipleVotes"),o.maxVotes=mt().attribute("maxVotes"),o.voteCount=mt().attribute("voteCount"),o.canVote=mt().attribute("canVote"),o.canEdit=mt().attribute("canEdit"),o.canDelete=mt().attribute("canDelete"),o.canSeeVoters=mt().attribute("canSeeVoters"),o.canChangeVote=mt().attribute("canChangeVote"),o.options=mt().hasMany("options"),o.votes=mt().hasMany("votes"),o.myVotes=mt().hasMany("myVotes"),o}return y(o,t),o.prototype.apiEndpoint=function(){return"/fof/polls"+(this.exists?"/"+this.data.id:"")},o}(mt()),ut=function(t){function o(){for(var o,n=arguments.length,e=new Array(n),a=0;a<n;a++)e[a]=arguments[a];return(o=t.call.apply(t,[this].concat(e))||this).answer=mt().attribute("answer"),o.imageUrl=mt().attribute("imageUrl"),o.voteCount=mt().attribute("voteCount"),o.poll=mt().hasOne("polls"),o.votes=mt().hasMany("votes"),o}return y(o,t),o.prototype.apiEndpoint=function(){return"/fof/polls/answers"+(this.exists?"/"+this.data.id:"")},o}(mt()),ct=function(t){function o(){for(var o,n=arguments.length,e=new Array(n),a=0;a<n;a++)e[a]=arguments[a];return(o=t.call.apply(t,[this].concat(e))||this).poll=mt().hasOne("poll"),o.option=mt().hasOne("option"),o.user=mt().hasOne("user"),o.pollId=mt().attribute("pollId"),o.optionId=mt().attribute("optionId"),o}return y(o,t),o.prototype.apiEndpoint=function(){return"/fof/polls/"+this.pollId()+"/vote"},o}(mt()),dt={Poll:pt,PollOption:ut,PollVote:ct};const ht=flarum.core.compat["common/extenders"];var ft=t.n(ht);const vt=flarum.core.compat["common/models/Post"];var bt=t.n(vt);const gt=flarum.core.compat["common/models/Forum"];var yt=t.n(gt);const wt=[(new(ft().Store)).add("polls",pt).add("poll_options",ut).add("poll_votes",ct),new(ft().Model)(bt()).hasMany("polls").attribute("canStartPoll"),new(ft().Model)(yt()).attribute("canStartPolls"),new(ft().Model)(u()).attribute("hasPoll").attribute("canStartPoll")];e().initializers.add("fof/polls",(function(){var t;(0,a.extend)(r().prototype,"requestParams",(function(t){t.include.push("poll")})),(0,a.extend)(u().prototype,"badges",(function(t){this.hasPoll()&&t.add("poll",s().component({type:"poll",label:e().translator.trans("fof-polls.forum.tooltip.badge"),icon:"fas fa-signal"}),5)})),A(f()),A(b()),(0,a.extend)(j().prototype,"content",(function(t){var o=this.attrs.post;if((!o.isHidden()||this.revealContent)&&o.polls())for(var n,e=function(t,o){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(n)return(n=n.call(t)).next.bind(n);if(Array.isArray(t)||(n=function(t,o){if(t){if("string"==typeof t)return et(t,o);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?et(t,o):void 0}}(t))||o&&t&&"number"==typeof t.length){n&&(t=n);var e=0;return function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(o.polls());!(n=e()).done;){var a=n.value;a&&t.push(m(tt,{post:o,poll:a}))}})),(0,a.extend)(j().prototype,"oninit",(function(){var t=this;this.subtree.check((function(){var o=t.attrs.post.polls(),n=null==o||null==o.map?void 0:o.map((function(t){var o,n,e,a,l;return t&&[null==(o=t.data)?void 0:o.attributes,null==(n=(e=t.options()).map)?void 0:n.call(e,(function(t){var o;return null==t||null==(o=t.data)?void 0:o.attributes})),null==(a=(l=t.myVotes()).map)?void 0:a.call(l,(function(t){var o;return null==(o=t.option())?void 0:o.id()}))]}));return JSON.stringify(n)}))})),(0,a.extend)(nt().prototype,"oncreate",(function(){e().pusher&&e().pusher.then((function(t){t.channels.main.bind("updatedPollOptions",(function(t){var o=e().store.getById("polls",t.pollId);o&&o.pushAttributes({voteCount:t.pollVoteCount});var n=t.options;for(var a in n){var l=e().store.getById("poll_options",a);l&&void 0!==l.voteCount()&&l.pushAttributes({voteCount:n[a]})}m.redraw()}))}))})),(0,a.extend)(nt().prototype,"onremove",(function(){e().pusher&&e().pusher.then((function(t){t.channels.main.unbind("updatedPollOptions")}))})),t=function(t){return e().modal.show(k,{onsubmit:function(o){return e().store.createRecord("polls").save(at({},o,{relationships:{post:t}}),{data:{include:"options,myVotes,myVotes.option"}}).then((function(o){var n;return null==(n=t.rawRelationship("polls"))||null==n.push||n.push({type:"polls",id:o.id()}),o}))}})},(0,a.extend)(st(),"moderationControls",(function(o,n){!n.isHidden()&&n.canStartPoll()&&o.add("addPoll",m(V(),{icon:"fas fa-poll",onclick:t.bind(this,n)},e().translator.trans("fof-polls.forum.moderation.add")))}))}))})(),module.exports=o})();
//# sourceMappingURL=forum.js.map